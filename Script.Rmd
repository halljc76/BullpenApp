---
title: "BullpenApp Project Script"
---

**BullpenApp Project Script** 
Carter Hall 

*Ideas* 
- Homepage 
- Welcome Message :)
- Basic Stats for Most Recent Session
(Pie Chart of Pitch Types, Session History, Max Velo, Max RPM, Recent Notes)

- Option Tab
- Checkboxes Here, Menus Here

- Pitch Plot for Session (Location, SZ)
- CheckboxGroup for Session Date(s)
- CheckboxGroup for Warmup/Live (Live standard opt.)
- SZ Toggle
- Baseball Image Toggle???

- Line Graph (Check Consistency, Duration of Sustaining XX mph Velo, XXXX RPMs, etc.)
- Use CG for Session Date(s)
- Dropdown to Specify Metric(s)
- Limit 2-3? Use 320 Stuff to Section Graph (GGPlot... Future Conversion to Plotly? )

```{r Libraries, message = FALSE, warning = FALSE}
options(shiny.maxRequestSize = 50*1024^2)
library(shiny)
library(shinydashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(shinythemes)
library(plotly)
```

```{r Functions message = FALSE, warning = FALSE}
library(DBI)
library(dbplyr)
library(RSQLite)

addTableDB <- function(conn, filename, tablename) {
  tables <- c(unname(as.list(queryDB(conn, "SELECT name FROM sqlite_master"))))
  if (!(tablename %in% tables[[1]])) {
    fn <- read.csv(filename)
    dbWriteTable(conn, tablename, fn)
  }
}

addData <- function(conn, filename, tablename) {
  
  # QUERY: Get all names of tables in database.
  tables <- c(unname(as.list(queryDB(conn, "SELECT name FROM sqlite_master"))))
  
  if (!(tablename %in% tables[[1]])) {
    fn <- read.csv(filename)
    dbWriteTable(conn, tablename, fn)
    
    suppressWarnings( 
      expr = {
        cols <- names(queryDB(conn, gsub(pattern = "_", replacement = tablename, x = "SELECT * FROM _")))
        for (col in cols) {
          # Query: Set any blank field from TM to be a null value.
          q <- gsub(pattern = "_", replacement = col, 
                    x = gsub(pattern = "-",
                             replacement = tablename, 
                             x = "UPDATE - SET _ = NULL WHERE _ = '' "))
          queryDB(conn, q)
        }
      }
    )
    
    queryDB(conn, gsub(
                  pattern = "-",
                  replacement = tablename,
                  # QUERY: Redefine 'Undefined' pitches to 'Warmup'
                  x = "UPDATE - SET TaggedPitchType = 'Warmup' 
                  WHERE TaggedPitchType = 'Undefined' "
                  )
    )
    
  }
}

queryDB <- function(conn, query) {
  return(dbGetQuery(conn, query))
}

obtainSession <- function(player) {
  # QUERY: Return a list of days when this player logged sessions.
  q <- "SELECT DISTINCT Date FROM TestData WHERE Pitcher = '_'"
  result <- list(unname(queryDB(conn, gsub(pattern = '_', replacement = player, x = q)))[[1]])
  names(result) <- result
  return(result)
}

getDate <- function() {
  date <- Sys.Date()
  return(
  gsub(pattern = " ",
       replacement = "",
       x= paste(substr(date, 6, 7), "/", 
                substr(date, 9, 10), "/", 
                substr(date, 1, 4)))
  )
}


locationDist <- function(warmupFlag, liveFlag, pitcher) {

  # QUERY: All queries in this function select (y,z) and pitch type.
  
  if (warmupFlag == TRUE && liveFlag == FALSE) {
    df <- queryDB(conn, 
                  gsub(pattern = "_",
                       replacement = pitcher,
                       x = "SELECT PlateLocSide, PlateLocHeight, 
                                   TaggedPitchType
                           FROM TestData
                          WHERE PitchSession != 'Live'
                          AND Pitcher = '_'
                          AND PlateLocSide IS NOT NULL
                          AND PlateLocHeight IS NOT NULL"
                       )
            )
  }
  
  if (warmupFlag == FALSE && liveFlag == TRUE) {
    df <- queryDB(conn, 
                  gsub(pattern = "_",
                       replacement = pitcher,
                       x = "SELECT PlateLocSide, PlateLocHeight, 
                                   TaggedPitchType
                           FROM TestData
                          WHERE PitchSession != 'Warmup'
                          AND Pitcher = '_'
                          AND PlateLocSide IS NOT NULL
                          AND PlateLocHeight IS NOT NULL"
                       )
            )
  }
  
  # If both or neither are selected, just plot everything.
  if (warmupFlag == liveFlag) {
    df <- queryDB(conn, 
                  gsub(pattern = "_",
                       replacement = pitcher,
                       x = "SELECT PlateLocSide, PlateLocHeight, 
                                   TaggedPitchType
                           FROM TestData
                           WHERE Pitcher = '_'
                           AND PlateLocSide IS NOT NULL
                           AND PlateLocHeight IS NOT NULL"
                       )
            )
  }
  
  
  fig <- suppressMessages(
    plot_ly(
      type = "scatter",
      mode = "markers",
      x = df$PlateLocSide,
      y = df$PlateLocHeight,
      color = ~as.factor(df$TaggedPitchType)
    ) %>% layout(
      shapes = list(type = "rect",
               line = list(color = "blue"),
               x0 = -0.783333, 
               x1 = 0.783333,
               xref = "x",
               y0 = 1.525,
               y1 = 3.316,
               yref = "y"),
      xaxis = list(range = c(-2, 2)),
      yaxis = list(range = c(-0.5, 4))
    ) 
  )
  
  return(fig)
}
```

```{r UI}
ui <- dashboardPage(
  title = "The Tar Pen",
  header = dashboardHeader(),
  sidebar = dashboardSidebar(
    sidebarMenu(
    menuItem(text = "Start Here", 
             tabName = "start",
             icon = icon("home"))
    )
  ),
  body = dashboardBody(
    
    tabItems(
      
      tabItem(
        tabName = "start",
        
        fluidRow(
          column(
            
            width = 3,
            offset = 0,
            
            h3("Player Name"),
            selectInput(inputId = "playerSelect",
                        label = NULL,
                        choices = NULL)
            ),
            
          column(
            width = 3, 
            offset = 0,
            
            h3("Session Date"),
            selectizeInput(inputId = "sessionSelect",
                           label = NULL,
                           choices = NULL)
            ),
          
          column(
            width = 2, 
            offset = 0,
            
            h3("Warmup/Live/Both?"),
            checkboxInput(inputId = "warmupSelect",
                          label = "Warmup",
                          value = FALSE),
            checkboxInput(inputId = "liveSelect",
                          label = "Live",
                          value = TRUE)
          )
        ),
        
        fluidRow(
          
          # Graph pitches by location
          # Table of most-often tilts
          
          box(title = "Strikezone Plot (Blue Rect.)",
              plotlyOutput(outputId = "szDisplay")),
          box(title = "Velo & Spin Graphs")
          
        ),
        
        fluidRow(
          box(title = "Previous Notes",
              width = 7,
              dataTableOutput(outputId = "notesDisplay")
              ),
          box(title = "Add Notes", 
              width = 5,
              textInput(inputId = "notesInput", label = "Enter Note Here"),
              actionButton(inputId = "notesSubmit", label = "Add Note")
              )
        )
      )
    )
  )
)
```

```{r Server}
server <- function(input, output, session) {
  
  # 'conn' is a GLOBAL var
  
  flags <- reactiveValues(ps = NULL, ss = NULL)
  
  updateSelectInput(
    
    session = session,
    inputId = "playerSelect",
    # QUERY: Return all names of pitchers in alphabetical order.
    choices = queryDB(conn, "SELECT DISTINCT Pitcher FROM TestData
                              ORDER BY Pitcher ASC"),
    selected = NULL
    
  )
  
  observeEvent(input$playerSelect,
               {
                 flags$ps <- input$playerSelect
                 
                 updateSelectizeInput(session = session,
                                      inputId = "sessionSelect",
                                      # QUERY: For a pitcher, obtain
                                      #        all dates of prev. sessions.
                                      choices = obtainSession(flags$ps)
                 )
                 
                 flags$ss <- input$sessionSelect
                 
               }
  )
  
  observeEvent(input$warmupSelect || input$liveSelect, 
      output$szDisplay <- renderPlotly(
        expr = {
          if (input$warmupSelect && input$liveSelect) {
            locationDist(T, T, flags$ps)
          }
          else if (input$liveSelect && !(input$warmupSelect)) {
            locationDist(F, T, flags$ps)
          }
          else {
          locationDist(T, F, flags$ps)
          }
        }
      )
  )
  
  output$notesDisplay <- renderDataTable(
                   expr = {
                     # QUERY: Select all notes and dates for this pitcher.
                     queryDB(conn,
                             paste("SELECT Date, Note FROM Notes 
                                    WHERE Pitcher = '", 
                                   input$playerSelect, "'", 
                                   "\n ORDER BY Date DESC", sep = "")
                     )
                   }
                 )
  
  observeEvent(input$notesSubmit, 
               {
                 queryDB(conn, 
                         # QUERY: Insert a new note, marked today.
                         paste("INSERT INTO Notes VALUES ", "('", 
                               input$playerSelect, "'", ", '", 
                               getDate(), "'", ", '", 
                               input$notesInput, "'", ")", sep = ""
                               )
                         )
                 updateTextInput(session = session,
                                 inputId = "notesInput", 
                                 label = "Enter Note Here",
                                 value = " "
                                 )
               })
  
  session$onSessionEnded(function() {
    dbDisconnect(conn)
  })
}
```

```{r Main}
### MAIN CHUNK ###

# Run This Code Before shinyApp()
# Use a .sqlite extension, not a .db
# Also, this doesn't have to exist already
conn <- dbConnect(RSQLite::SQLite(), "bullpen.sqlite")

# Make SURE the final param in this call matches the 
# corresponding name given to the server-side queries!!!
addData(conn, "TestData.csv", "TestData")

# DO NOT CHANGE THIS LINE :)
invisible(queryDB(conn, "CREATE Table IF NOT EXISTS Notes (Pitcher text, Date text, Note text)"))
shinyApp(ui, server)
```


```{r}
locationDist(T, F, "Sandy, Will")
```

