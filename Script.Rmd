---
title: "BullpenApp Project Script"
---

**BullpenApp Project Script** 
Carter Hall 

*Ideas* 
- Homepage 
- Welcome Message :)
- Basic Stats for Most Recent Session
(Pie Chart of Pitch Types, Session History, Max Velo, Max RPM, Recent Notes)

- Option Tab
- Checkboxes Here, Menus Here

- Pitch Plot for Session (Location, SZ)
- CheckboxGroup for Session Date(s)
- CheckboxGroup for Warmup/Live (Live standard opt.) --> Implement this in Server
- SZ Toggle
- Baseball Image Toggle???

- Line Graph (Check Consistency, Duration of Sustaining XX mph Velo, XXXX RPMs, etc.)
- Use CG for Session Date(s)
- Dropdown to Specify Metric(s)
- Limit 2-3? Use 320 Stuff to Section Graph (GGPlot... Future Conversion to Plotly? )


```{r Libraries, message = FALSE, warning = FALSE}
options(shiny.maxRequestSize = 50*1024^2)
library(shiny)
library(shinydashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(shinythemes)
```

```{r Functions message = FALSE, warning = FALSE}
library(DBI)
library(dbplyr)
library(RSQLite)

addTableDB <- function(conn, filename, tablename) {
  tables <- c(unname(as.list(queryDB(conn, "SELECT name FROM sqlite_master"))))
  if (!(tablename %in% tables[[1]])) {
    fn <- read.csv(filename)
    dbWriteTable(conn, tablename, fn)
  }
}

addData <- function(conn, filename, tablename) {
  
  tables <- c(unname(as.list(queryDB(conn, "SELECT name FROM sqlite_master"))))
  
  if (!(tablename %in% tables[[1]])) {
    fn <- read.csv(filename)
    dbWriteTable(conn, tablename, fn)
    
    suppressWarnings( 
      expr = {
        cols <- names(queryDB(conn, gsub(pattern = "_", replacement = tablename, x = "SELECT * FROM _")))
        for (col in cols) {
          q <- gsub(pattern = "_", replacement = col, 
                    x = gsub(pattern = "-",
                             replacement = tablename, 
                             x = "UPDATE - SET _ = NULL WHERE _ = '' "))
          queryDB(conn, q)
        }
      }
    )
    
  }
}

queryDB <- function(conn, query) {
  return(dbGetQuery(conn, query))
}

obtainSession <- function(player) {
  q <- "SELECT DISTINCT Date FROM TestData WHERE Pitcher = '_'"
  result <- list(unname(queryDB(conn, gsub(pattern = '_', replacement = player, x = q)))[[1]])
  names(result) <- result
  return(result)
}

getDate <- function() {
  date <- Sys.Date()
  return(
  gsub(pattern = " ",
       replacement = "",
       x= paste(substr(date, 6, 7), "/", 
                substr(date, 9, 10), "/", 
                substr(date, 1, 4)))
  )
}
```

```{r UI}
ui <- dashboardPage(
  title = "The Tar Pen",
  header = dashboardHeader(),
  sidebar = dashboardSidebar(
    sidebarMenu(
    menuItem(text = "Start Here", 
             tabName = "start",
             icon = icon("home"))
    )
  ),
  body = dashboardBody(
    
    tabItems(
      
      tabItem(
        tabName = "start",
        
        fluidRow(
          column(
            
            width = 3,
            offset = 0,
            
            h3("Player Name"),
            selectInput(inputId = "playerSelect",
                        label = NULL,
                        choices = NULL)
            ),
            
          column(
            width = 3, 
            offset = 0,
            
            h3("Session Date"),
            selectizeInput(inputId = "sessionSelect",
                           label = NULL,
                           choices = NULL)
            ),
          
          column(
            width = 2, 
            offset = 0,
            
            h3("Warmup/Live/Both?"),
            checkboxGroupInput(inputId = "warmupLiveSelect",
                               label = NULL,
                               choices = c("Warmup" = "w",
                                           "Live" = "l")
            )
            
          )
        ),
        
        fluidRow(
          
          box(title = "Pitch Locations"),
          box(title = "Velo & Spin Graphs")
          
        ),
        
        fluidRow(
          box(title = "Previous Notes",
              width = 7),
          box(title = "Add Notes", 
              width = 5,
              textInput(inputId = "notesInput", label = "Enter Note Here"),
              actionButton(inputId = "notesSubmit", label = "Add Note"))
        )
      )
    )
  )
)
```

```{r Server}
server <- function(input, output, session) {
  
  # 'conn' is a GLOBAL var
  
  flags <- reactiveValues(ps = NULL, ss = NULL, w = NULL, l = NULL)
  
  updateSelectInput(
    
    session = session,
    inputId = "playerSelect",
    # QUERY: Return all names of pitchers in alphabetical order.
    choices = queryDB(conn, "SELECT DISTINCT Pitcher FROM TestData
                              ORDER BY Pitcher ASC"),
    selected = NULL
    
  )
  
  observeEvent(input$playerSelect,
               {
                 flags$ps <- input$playerSelect
                 
                 updateSelectizeInput(session = session,
                                      inputId = "sessionSelect",
                                      # QUERY: For a pitcher, obtain
                                      #        all dates of prev. sessions.
                                      choices = obtainSession(flags$ps)
                 )
                 
                 flags$ss <- input$sessionSelect
                 
               }
  )
  
  observeEvent(input$warmupLiveSelect, 
               {
                 # When using, check if not NA
                 flags$w <- input$warmupLiveSelect[1]
                 flags$l <- input$warmupLiveSelect[2]
               })
  
  observeEvent(input$notesSubmit, 
               {
                 queryDB(conn, 
                         paste("INSERT INTO Notes VALUES ", "('", 
                               input$playerSelect, "'", ", '", 
                               getDate(), "'", ", '", 
                               input$notesInput, "'", ")", sep = ""
                               )
                         )
               })
  
  session$onSessionEnded(function() {
    dbDisconnect(conn)
  })
}
```

```{r Main}
### MAIN CHUNK ###

# Run This Code Before shinyApp()
# Use a .sqlite extension, not a .db
# Also, this doesn't have to exist already
conn <- dbConnect(RSQLite::SQLite(), "bullpen.sqlite")
addData(conn, "TestData.csv", "TestData")

# DO NOT CHANGE THIS LINE :)
invisible(queryDB(conn, "CREATE Table IF NOT EXISTS Notes (Pitcher text, Date text, Note text)"))
shinyApp(ui, server)
```




