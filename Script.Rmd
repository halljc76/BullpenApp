---
title: "BullpenApp Project Script"
author: "Carter Hall"
---

**BullpenApp Project Script** 
Carter Hall 
Email: *halljc76@live.unc.edu*

```{r Libraries, message = FALSE, warning = FALSE}
options(shiny.maxRequestSize = 50*1024^2)
library(shiny)
library(shinydashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(shinythemes)
library(plotly)
library(DBI)
library(dbplyr)
library(RSQLite)
```

```{r Functions message = FALSE, warning = FALSE}
addTableDB <- function(conn, filename, tablename) {
  tables <- c(unname(as.list(queryDB(conn, "SELECT name FROM sqlite_master"))))
  if (!(tablename %in% tables[[1]])) {
    fn <- read.csv(filename)
    dbWriteTable(conn, tablename, fn)
  }
}

addData <- function(conn, filename, tablename) {
  
  # QUERY: Get all names of tables in database.
  tables <- c(unname(as.list(queryDB(conn, "SELECT name FROM sqlite_master"))))
  
  if (!(tablename %in% tables[[1]])) {
    fn <- read.csv(filename)
    dbWriteTable(conn, tablename, fn)
    
    suppressWarnings( 
      expr = {
        cols <- names(queryDB(conn, gsub(pattern = "_", replacement = tablename, x = "SELECT * FROM _")))
        for (col in cols) {
          # Query: Set any blank field from TM to be a null value.
          q <- gsub(pattern = "_", replacement = col, 
                    x = gsub(pattern = "-",
                             replacement = tablename, 
                             x = "UPDATE - SET _ = NULL WHERE _ = '' "))
          queryDB(conn, q)
        }
      }
    )
    
    queryDB(conn, gsub(
      pattern = "-",
      replacement = tablename,
      # QUERY: Redefine 'Undefined' pitches to 'Warmup'
      x = "UPDATE - SET TaggedPitchType = 'Warmup' 
                  WHERE TaggedPitchType = 'Undefined' "
    )
    )
    
  }
}

queryDB <- function(conn, query) {
  return(dbGetQuery(conn, query))
}

obtainSession <- function(player) {
  # QUERY: Return a list of days when this player logged sessions.
  q <- "SELECT DISTINCT Date FROM TestData WHERE Pitcher = '_'"
  result <- list(unname(queryDB(conn, gsub(pattern = '_', replacement = player, x = q)))[[1]])
  names(result) <- result
  return(result)
}

getDate <- function() {
  date <- Sys.Date()
  return(
    gsub(pattern = " ",
         replacement = "",
         x= paste(substr(date, 6, 7), "/", 
                  substr(date, 9, 10), "/", 
                  substr(date, 1, 4)))
  )
}


summaryStats <- function(pitcher, sessionDate) {
  df <- locationDist(F, T, pitcher, F, sessionDate)
  tot <- 0
  pct <- c()
  names <- c()
  avgVelos <- c()
  avgSpins <- c()
  i = 1
  for (pt in unique(df$TaggedPitchType)) {
    ct <- unname(
      as.list(
        queryDB(
          conn, 
          query = gsub(pattern = '_', replacement = pt,
                       x = gsub(pattern = '--',replacement = pitcher,
                                x = gsub(pattern = '---', replacement = sessionDate,
                                         x = "SELECT COUNT(*) 
                                               FROM TestData
                                              WHERE TaggedPitchType = '_'
                                                AND TaggedPitchType != 'Warmup'
                                                AND Pitcher = '--'
                                                AND Date = '---'")))))[[1]])
    
    avgVelo <- unname(
      as.list(
        queryDB(
          conn, 
          query = gsub(pattern = '_', replacement = pt,
                       x = gsub(pattern = '--',replacement = pitcher,
                                x = gsub(pattern = '---', replacement = sessionDate,
                                         x = "SELECT AVG(ZoneSpeed)
                                               FROM TestData
                                              WHERE TaggedPitchType = '_'
                                                AND TaggedPitchType != 'Warmup'
                                                AND Pitcher = '--'
                                                AND Date = '---'
                                                AND ZoneSpeed IS NOT NULL")))))[[1]])
    
    avgSpin <- unname(
      as.list(
        queryDB(
          conn, 
          query = gsub(pattern = '_', replacement = pt,
                       x = gsub(pattern = '--',replacement = pitcher,
                                x = gsub(pattern = '---', replacement = sessionDate,
                                         x = "SELECT AVG(SpinRate)
                                               FROM TestData
                                              WHERE TaggedPitchType = '_'
                                                AND TaggedPitchType != 'Warmup'
                                                AND Pitcher = '--'
                                                AND Date = '---'
                                                AND SpinRate IS NOT NULL")))))[[1]])
    
    tot = tot + ct
    pct[i] <- ct
    names[i] <- pt
    avgVelos[i] <- round(avgVelo, digit = 2)
    avgSpins[i] <- round(avgSpin, digit = 0)
    i = i + 1
  }
  
  pct <- round(pct / tot, digit = 2) * 100
  ret <- data.frame(pitches = names, percents = pct, 
                    avgVelos = avgVelos, avgSpins = avgSpins)
    colnames(ret) <- c("Pitch", "% Thrown", "Avg. Velo", "Avg. Spin")
  return(ret)
}

locationDist <- function(warmupFlag, liveFlag, pitcher, plotBool, sessionDate) {
  
  # QUERY: All queries in this function select (y,z) and pitch type.
  
  if (warmupFlag == TRUE && liveFlag == FALSE) {
    df <- queryDB(conn, 
                  gsub(pattern = "_",
                       replacement = pitcher,
                       x = gsub(pattern = '--', replacement = sessionDate,
                               x = "SELECT PlateLocSide, PlateLocHeight, 
                                           TaggedPitchType, Tilt, ZoneSpeed
                                   FROM TestData
                                  WHERE PitchSession != 'Live'
                                  AND Pitcher = '_'
                                  AND Date = '--'
                                  AND PlateLocSide IS NOT NULL
                                  AND PlateLocHeight IS NOT NULL
                                  AND ZoneSpeed IS NOT NULL"
                               )
                  )
    )
  }
  
  if (warmupFlag == FALSE && liveFlag == TRUE) {
    df <- queryDB(conn, 
                  gsub(pattern = "_",
                       replacement = pitcher,
                       x = gsub(pattern = '--', replacement = sessionDate,
                               x = "SELECT PlateLocSide, PlateLocHeight, 
                                           TaggedPitchType, Tilt, ZoneSpeed
                                   FROM TestData
                                  WHERE PitchSession != 'Warmup'
                                  AND Pitcher = '_'
                                  AND Date = '--'
                                  AND PlateLocSide IS NOT NULL
                                  AND PlateLocHeight IS NOT NULL
                                  AND ZoneSpeed IS NOT NULL"
                               )
                  )
    )
  }
  
  # If both or neither are selected, just plot everything.
  if (warmupFlag == liveFlag) {
    df <- queryDB(conn, 
                  gsub(pattern = "_",
                       replacement = pitcher,
                       x = gsub(pattern = '--', replacement = sessionDate,
                               x = "SELECT PlateLocSide, PlateLocHeight, 
                                           TaggedPitchType, Tilt, ZoneSpeed
                                   FROM TestData
                                  WHERE Pitcher = '_'
                                  AND Date = '--'
                                  AND PlateLocSide IS NOT NULL
                                  AND PlateLocHeight IS NOT NULL
                                  AND ZoneSpeed IS NOT NULL"
                               )
                  )
    )
  }
  
  if (plotBool){
    fig <- suppressMessages(
      plot_ly(
        type = "scatter",
        mode = "markers",
        x = df$PlateLocSide,
        y = df$PlateLocHeight,
        color = ~as.factor(df$TaggedPitchType),
        hoverinfo = "text",
        text = ~paste(df$TaggedPitchType, "\nTilt: ", df$Tilt, 
                      "\nVelo: ", round(df$ZoneSpeed, 1), " MPH", sep = "")
      ) %>% layout(
        shapes = list(type = "rect",
                      line = list(color = "blue"),
                      x0 = -0.783333, 
                      x1 = 0.783333,
                      xref = "x",
                      y0 = 1.525,
                      y1 = 3.316,
                      yref = "y"),
        xaxis = list(range = c(-2, 2)),
        yaxis = list(range = c(-0.5, 4))
      ) 
    )
    
    return(fig)
  }
  
  return(df)
}

spinVeloGraphs <- function(warmupFlag, liveFlag, pitcher, sessionDate, spinVeloFlag) {
  
  print(pitcher)
  
  if (!warmupFlag && liveFlag) {
    pts <- as.list(queryDB(conn, paste("SELECT DISTINCT TaggedPitchType FROM TestData 
               WHERE Pitcher = '", pitcher , "' AND TaggedPitchType != 'Warmup'
               AND Date = '", sessionDate, "'", sep = "")))
    df <- data.frame()

    for (pt in unname(pts)[[1]]) {
      # Finish this :)
      temp <- queryDB(conn, paste("SELECT ROW_NUMBER() OVER() AS Row, TaggedPitchType,
                                  ZoneSpeed, SpinRate
                             FROM TestData 
                            WHERE Pitcher = '", pitcher, 
                           "' AND Date = '", sessionDate, "'", 
                              "AND TaggedPitchType = '", pt, "'",
                              "AND TaggedPitchType != 'Warmup'
                               AND ZoneSpeed IS NOT NULL 
                               AND SpinRate IS NOT NULL",
                          sep = ""))
      
      df <- rbind(df, temp)
      
    }
  }
  
  else if (!liveFlag && warmupFlag) {
    pts <- as.list(queryDB(conn, paste("SELECT DISTINCT TaggedPitchType FROM TestData 
               WHERE Pitcher = '", pitcher , "' AND TaggedPitchType != 'Live'", sep = "")))
    df <- data.frame()
    
    
    for (pt in unname(pts)[[1]]) {
      # Finish this :)
      temp <- queryDB(conn, paste("SELECT ROW_NUMBER() OVER() AS Row, TaggedPitchType,
                                  ZoneSpeed, SpinRate
                             FROM TestData 
                            WHERE Pitcher = '", pitcher, 
                           "' AND Date = '", sessionDate, "'", 
                              "AND TaggedPitchType = '", pt, "'",
                              "AND TaggedPitchType != 'Live'
                               AND ZoneSpeed IS NOT NULL 
                               AND SpinRate IS NOT NULL",
                          sep = ""))
      
      df <- rbind(df, temp)
      
    }
  }
  
  else {
    pts <- as.list(queryDB(conn, paste("SELECT DISTINCT TaggedPitchType FROM TestData 
               WHERE Pitcher = '", pitcher, "'", sep = "")))
    df <- data.frame()
    
    for (pt in unname(pts)[[1]]) {
      print(pt)
      # Finish this :)
      temp <- queryDB(conn, paste("SELECT ROW_NUMBER() OVER() AS Row, TaggedPitchType,
                                  ZoneSpeed, SpinRate
                             FROM TestData 
                            WHERE Pitcher = '", pitcher, 
                           "' AND Date = '", sessionDate, "'", 
                              "AND TaggedPitchType = '", pt, "'",
                              "AND ZoneSpeed IS NOT NULL 
                               AND SpinRate IS NOT NULL",
                          sep = ""))
      
      df <- rbind(df, temp)
      
    } 
  }
  
  if (spinVeloFlag) {
    return(
          plot_ly(data = df %>% group_by(df$TaggedPitchType),
                  x = ~df$Row, 
                  y = ~df$ZoneSpeed, 
                  type = "scatter",
                  color = ~df$TaggedPitchType,
                  mode = "lines+markers",
                  hoverinfo = "text",
                  text = ~paste(df$Row, ": ", round(df$ZoneSpeed, 1), " MPH", 
                                sep = "")) %>% 
                  layout(xaxis = list(            
                         tickvals = ~df$Row,
                         tickangle = 0,
                         title = "Pitch #"),
                         
                         yaxis = (
                           list(title = "Velo (MPH)")
                           )
                         )
          )
  }
  else {
    return(
      plot_ly(data = df %>% group_by(df$TaggedPitchType),
              x = ~df$Row, 
              y = ~df$SpinRate, 
              type = "scatter",
              color = ~df$TaggedPitchType,
              mode = "lines+markers",
              hoverinfo = "text",
              text = ~paste(df$Row, ": ", round(df$SpinRate, 0), " RPM", 
                            sep = "")) %>% 
              layout(xaxis = list(            
                     tickvals = ~df$Row,
                     tickangle = 0,
                     title = "Pitch #"),
                     
                     yaxis = list(
                       title = "Spin (RPM)"
                       )
                     )
      )
  }
}
```

```{r UI}
ui <- dashboardPage(
  title = "The Tar Pen",
  header = dashboardHeader(),
  sidebar = dashboardSidebar(
    sidebarMenu(
      menuItem(text = "Start Here", 
               tabName = "start",
               icon = icon("home"))
    )
  ),
  body = dashboardBody(
    
    tabItems(
      
      tabItem(
        tabName = "start",
        
        fluidRow(
          column(
            
            width = 3,
            offset = 0,
            
            h3("Player Name"),
            selectInput(inputId = "playerSelect",
                        label = NULL,
                        choices = NULL)
          ),
          
          column(
            width = 3, 
            offset = 0,
            
            h3("Session Date"),
            selectInput(inputId = "sessionSelect",
                           label = NULL,
                           choices = NULL)
          ),
          
          column(
            width = 2, 
            offset = 0,
            
            h3("Warmup/Live/Both?"),
            checkboxInput(inputId = "warmupSelect",
                          label = "Warmup",
                          value = FALSE),
            checkboxInput(inputId = "liveSelect",
                          label = "Live",
                          value = TRUE)
          )
        ),
        
        fluidRow(
          box(title = "Previous Notes",
              width = 6,
              div(style = "display:inline-block",
                  textInput(inputId = "notesInput", 
                            label = "Enter Note Here")),
              div(style = "display:inline-block",
                  actionButton(inputId = "notesSubmit", 
                               label = "Add Note")),
              dataTableOutput(outputId = "notesDisplay"),
              
          ),
          box(title = "Summary Statistics", 
              width = 6,
              dataTableOutput(outputId = "summStatsDisplay")
          )
        ),
        
        fluidRow(
          
          # Graph pitches by location
          # Table of most-often tilts
          
          box(title = "Strikezone Plot (Hover to See Speed and Tilt)",
              plotlyOutput(outputId = "szDisplay")),
          box(title = "Velo & Spin Graphs",
              plotlyOutput(outputId = "veloDisplay", height = "200px"),
              plotlyOutput(outputId = "spinDisplay", height = "200px"))
        )
      )
    )
  )
)
```

```{r Server}
server <- function(input, output, session) {
  
  # 'conn' is a GLOBAL var
  
  flags <- reactiveValues(ps = NULL, ss = NULL)
  
  updateSelectInput(
    
    session = session,
    inputId = "playerSelect",
    # QUERY: Return all names of pitchers in alphabetical order.
    choices = queryDB(conn, "SELECT DISTINCT Pitcher FROM TestData
                              ORDER BY Pitcher ASC"),
    selected = NULL
    
  )
  
  observeEvent(input$playerSelect,
               {
                 flags$ps <- input$playerSelect
                 
                 updateSelectInput(session = session,
                                   inputId = "sessionSelect",
                                   # QUERY: For a pitcher, obtain
                                   #        all dates of prev. sessions.
                                   choices = obtainSession(flags$ps)
                 )
               }
  )
  
  observeEvent(input$sessionSelect, 
               {
                 flags$ss <- input$sessionSelect
               }
               )
  
  observeEvent(input$warmupSelect || input$liveSelect, 
               {
               output$szDisplay <- renderPlotly(
                 expr = {
                   if (input$warmupSelect && input$liveSelect) {
                     locationDist(T, T, flags$ps, T, flags$ss)
                   }
                   else if (input$liveSelect && !(input$warmupSelect)) {
                     locationDist(F, T, flags$ps, T, flags$ss)
                   }
                   else {
                     locationDist(T, F, flags$ps, T, flags$ss)
                   }
                 }
               )
               
               output$veloDisplay <- renderPlotly(
                 expr = {
                   spinVeloGraphs(input$warmupSelect, input$liveSelect, 
                                  input$playerSelect, input$sessionSelect, T)
                 }
               )
               
               output$spinDisplay <- renderPlotly(
                 expr = {
                   spinVeloGraphs(input$warmupSelect, input$liveSelect, 
                                  input$playerSelect, input$sessionSelect, F)
                 }
               )
               }
  )
  
  output$notesDisplay <- renderDataTable(
    expr = {
      # QUERY: Select all notes and dates for this pitcher.
      queryDB(conn,
              paste("SELECT Date, Note FROM Notes 
                                    WHERE Pitcher = '", 
                    input$playerSelect, "'", 
                    "\n ORDER BY Date DESC", sep = "")
      )
    }
  )
  
  observeEvent(input$notesSubmit, 
               {
                 queryDB(conn, 
                         # QUERY: Insert a new note, marked today.
                         paste("INSERT INTO Notes VALUES ", "('", 
                               input$playerSelect, "'", ", '", 
                               getDate(), "'", ", '", 
                               input$notesInput, "'", ")", sep = ""
                         )
                 )
                 updateTextInput(session = session,
                                 inputId = "notesInput", 
                                 label = "Enter Note Here",
                                 value = " "
                 )
               })
  
  output$summStatsDisplay <- renderDataTable(
    expr = {
      # If the UI seems to throw an error... don't know why. It works nonetheless!
      
      # QUERY: Get the summary statistics (pitch, percent thrown, velo, spin).
      summaryStats(flags$ps, flags$ss)
    }
  )
  
  session$onSessionEnded(function() {
    dbDisconnect(conn)
  })
}
```

```{r Main}
### MAIN CHUNK ###

# Run This Code Before shinyApp()
# Use a .sqlite extension, not a .db
# If an error of 'invalid connection' occurs somewhere, refresh this line.
# Also, the second parameter doesn't have to exist already
conn <- dbConnect(RSQLite::SQLite(), "bullpen.sqlite")

# Make SURE the final param in this call matches the 
# corresponding name given to the server-side queries!!!
addData(conn, "TestData.csv", "TestData")

# DO NOT CHANGE THIS LINE :)
invisible(queryDB(conn, "CREATE Table IF NOT EXISTS Notes (Pitcher text, Date text, Note text)"))

## IMPORTANT ##
# Sometimes, the app throws error messages on-startup. 
# This is, to the best of my knowledge, simply because some things take awhile
# to execute in comparison. 

# The code SHOULD function (startup time probably around 5 seconds... but
# I doubt this would be too much of an issue as it isn't the homepage of the app,
# and anything could run before someone gets to it.)

# Do, however, let anyone using this know that if it complains, it's not them!
###############
shinyApp(ui, server)
```



